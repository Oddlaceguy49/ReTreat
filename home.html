<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReTreat - Home</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!--<script src="https://retreat-4vv.pages.dev/scripts/home.js"></script>-->
    <link rel="stylesheet" href="https://retreat-4vv.pages.dev/styles/home.css">
</head>

<body>

<button id="settings" onclick="settings()">Settings</button>
<button id="logout" onclick="logout()">Logout</button>
<button id="mode-toggle" onclick="toggleMode()"><img src="https://retreat-4vv.pages.dev/assets/moon.png" width="40" height="40"></button>

<div class="container">
    <div class="post-box">
        <div class="textarea">
            <textarea id="postContent" placeholder="What's on your mind?"></textarea><br>
        </div>
        <button onclick="submitPost()">Post</button>
    </div>

    <div id="message"></div>

    <h1>Posts</h1>
    <div class="posts-container" id="posts"></div>
    <p id="loading">Loading more posts...</p>
</div>
<script>
let offset = 0;
const limit = 10;
let loading = false;
let allPostsLoaded = false;

function getCookie(name) {
    const cookies = document.cookie.split("; ");
    for (const cookie of cookies) {
        const [key, value] = cookie.split("=");
        if (name === key) {
            return decodeURIComponent(value);
        }
    }
    return null;
}

const accentColor = getCookie("accentcolour") ? `#${getCookie("accentcolour")}` : "#007bff";

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("button").forEach(button => {
        button.style.backgroundColor = accentColor;
    });

    // Load initial posts and attach scroll listener
    loadPosts();
    window.addEventListener("scroll", handleScroll);
});

async function loadPosts() {
    if (loading) {
        console.log("Already loading posts, skipping...");
        return;
    }
    if (allPostsLoaded) {
        console.log("All posts are loaded, no more requests.");
        return;
    }
    console.log("Loading new posts...");

    loading = true;
    const loadingIndicator = document.getElementById("loading");
    loadingIndicator.style.display = "block";

    try {
        console.log(`Attempting to fetch: offset=${offset}, limit=${limit}`);
		const response = await fetch(`https://getposts.retreat.workers.dev/?offset=${offset}&limit=${limit}`);
		console.log("Fetch response status:", response.status);

        const data = await response.json();
		console.log("Response data:", data);
		console.log("data.success:", data.success);
		console.log("data.posts:", data.posts);
		console.log("Number of posts:", data.posts ? data.posts.length : "undefined");

        if (response.ok && data.success) {
            if (data.posts.length === 0) {
                allPostsLoaded = true;
                loadingIndicator.innerText = "No more posts.";
                return;
            }

            const postsContainer = document.getElementById("posts");
            data.posts.forEach(post => {
				console.log("Rendering post:", post);
				const formattedContent = post.content.replace(/\n/g, "<br>");
				const newPost = document.createElement("div");
				newPost.className = "post";
				newPost.innerHTML = `
					<p><strong>${post.username}:</strong></p>
					<p>${formattedContent}</p>`;
				document.getElementById("posts").appendChild(newPost);
			});


            offset += limit; // Increment offset for the next batch
        } else {
            throw new Error("Failed to fetch posts.");
        }
    } catch (error) {
        console.error("Error:", error);
        loadingIndicator.innerText = "Failed to load posts.";
    } finally {
        loading = false;
        loadingIndicator.style.display = "none";
    }
}

function handleScroll() {
    console.log("Scroll Position:", window.innerHeight + window.scrollY); // Debugging line
    console.log("Document Height:", document.documentElement.scrollHeight); // Debugging line

    const scrollPosition = window.innerHeight + window.scrollY;
    const threshold = document.documentElement.scrollHeight - 100;

    if (scrollPosition >= threshold) {
        console.log("Threshold reached!");
        loadPosts();
    }
}
</script>
</body>
</html>
